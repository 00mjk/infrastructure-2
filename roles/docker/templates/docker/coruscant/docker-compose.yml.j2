version: '3.7'
services:
  # maintenance
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: always
    depends_on:
      - traefik
    expose:
      - 8080
    environment:
      DOCKER_HOST: tcp://docker-proxy:2375
    networks:
      - proxy
      - docker
    labels:
      - traefik.enable=true
      - traefik.http.routers.dozzle.rule=Host(`dozzle.{{ domain }}`)
      - traefik.http.routers.dozzle.entrypoints=https
      - traefik.http.routers.dozzle.tls=true
      - traefik.http.routers.dozzle.tls.certresolver=digitalocean
      - traefik.http.routers.dozzle.middlewares=auth@file,security@file,error-pages@file

  # security
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-proxy
    restart: always
    expose:
      - 2375
    environment:
      INFO: 1
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
      SERVICES: 1
      POST: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - docker
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: always
    network_mode: host
    environment:
      TZ: '{{ timezone }}'
      F2B_LOG_TARGET: STDOUT
      F2B_LOG_LEVEL: INFO
      F2B_DB_PURGE_AGE: 1d
      SSMTP_HOST: '{{ vault.smtp.host }}'
      SSMTP_PORT: '{{ vault.smtp.port }}'
      # SSMTP_HOSTNAME: example.com
      SSMTP_USER: '{{ vault.smtp.accounts.auth.email }}'
      SSMTP_PASSWORD: '{{ vault.smtp.accounts.auth.password }}'
      SSMTP_TLS: 'YES'
    volumes:
      - /var/log:/var/log:ro
      - '{{ root_path }}/fail2ban:/data'
    cap_add:
      - NET_ADMIN
      - NET_RAW
networks:
  proxy:
    ipam:
      config:
        - subnet: 172.20.1.0/24
          gateway: 172.20.1.1
  monitoring:
    ipam:
      config:
        - subnet: 172.20.2.0/24
          gateway: 172.20.2.1
  dns:
    ipam:
      config:
        - subnet: 172.20.3.0/24
          gateway: 172.20.3.1
  docker:
    ipam:
      config:
        - subnet: 172.20.4.0/24
          gateway: 172.20.4.1
volumes:
